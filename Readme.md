# Ход выполнения итогового задания

1. Пишем файл конфигурации инфраструктуры для terraform.
см. каталог */1_terraform*

3. Выполняем установку инфраструктуры с помощью terrafom:
Проверяем конфиг на ошибки
```
terraform validate
```
Инициализируем проект
```
terraform init
```
Выводим на экран план изменений, которые выполнит terraform
```
terraform plan
```
Применим изменения
```
terraform apply
```
Получаем в качестве вывода внешние и локальные адреса 3-х виртуальных машин:

external_ip_address_vm_1 = "158.160.109.47"
external_ip_address_vm_2 = "158.160.103.171"
external_ip_address_vm_3 = "158.160.97.56"
internal_ip_address_vm_1 = "10.128.0.28"
internal_ip_address_vm_2 = "10.128.0.9"
internal_ip_address_vm_3 = "10.128.0.7"

Скриншот полученной инфраструктуры в файле *screenshots/Yandex_Cloud_VMs.png*

4. Устанавливаем docker на 3 ноды с помощью Ansible
В каталоге */2_Install_docker* в файле inventory прописываем ip адреса полученных виртуальных машин, запускаем выполнение плэйбука.
```
ansible-playbook playbook.yml
```

5. Создаем кластер docker swarm
В каталоге */3_Init_docker_swarm_cluster* в файле inventory прописываем ip адрес виртуальной машины, которая будет выполнять роль менеджера в кластере. Запускаем плэйбук.

6. Добавляем 2 оставшихся виртуальные машины в кластер в роли worker.
В каталоге */4_Add_Node_to_docker_swarm* в файле inventory прописываем ip адрес виртуальной машины, которая будет выполнять роль worker. Выполняем на ноде менеджера 
```
docker swarm join-token worker
```
Полученный токен вносим в плэйбук и выполняем его.

7. Проверяем на ноде менеджера, подключились ли воркеры.
Скриншот *screenshots/docker_node_ls_command.png*

8. Скачиваем из репозитория и редактируем файл docker-compose.yml и готовим его для развертывания через docker swarm.
Измененный файл доступен в */5_Deploy/docker-compose.yml* (для каждого сервиса указываем, на какие ноды их деплоить и сколько реплик каждого сервиса делать).

9. Деплоим исходники магазина
Ansible плэйбук деплоя доступен в */5_Deploy*

10. Проверяем работу магазина.
Открываем в браузере страницу магазина по 3-м имеющимся внешним адресам наших виртуальных машин Yandex.Cloud (см. скриншоты *screenshots/Main_pager_Node-1,2,3.png*).

Скриншоты *screenshots/docker_ps_Node-1,2,3.png* показывают, как docker swarm распределил по нодам задания. В соответствии с заданием видим 2 реплики фронтэнда.

На менеджере выполняем
```
docker service ls
```
Вывод виден на скриншоте *screenshots/docker_service_ls_command.png*